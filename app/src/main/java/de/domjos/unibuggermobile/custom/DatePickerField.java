/*
 * Copyright (C)  2019-2024 Domjos
 * This file is part of UniTrackerMobile <https://unitrackermobile.de/>.
 *
 * UniTrackerMobile is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * UniTrackerMobile is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with UniTrackerMobile. If not, see <http://www.gnu.org/licenses/>.
 */

package de.domjos.unibuggermobile.custom;

import android.app.DatePickerDialog;
import android.app.TimePickerDialog;
import android.content.Context;
import android.text.InputType;
import android.text.method.DigitsKeyListener;
import android.util.AttributeSet;

import java.util.Date;
import java.util.Calendar;
import java.util.Objects;

import de.domjos.customwidgets.utils.ConvertHelper;
import de.domjos.unibuggermobile.activities.MainActivity;

public class DatePickerField extends androidx.appcompat.widget.AppCompatEditText {
    private Context context;
    private String dateFormat, timeFormat;
    private DatePickerDialog.OnDateSetListener onDateSetListener;
    private TimePickerDialog.OnTimeSetListener onTimeSetListener;
    private Calendar calendar;
    private boolean timePicker;

    public DatePickerField(Context context) {
        super(context);

        this.setParams(context);
        this.initDialog();
        this.initActions();
    }

    public DatePickerField(Context context, AttributeSet attrs) {
        super(context, attrs);

        this.setParams(context);
        this.initDialog();
        this.initActions();
    }

    public DatePickerField(Context context, AttributeSet attrs, int defStyleAttr) {
        super(context, attrs, defStyleAttr);

        this.setParams(context);
        this.initDialog();
        this.initActions();
    }

    public void setTimePicker(boolean timePicker) {
        this.timePicker = timePicker;
    }

    private void setParams(Context context) {
        this.context = context;
        this.dateFormat = MainActivity.GLOBALS.getSettings(this.context).getDateFormat();
        this.timeFormat = MainActivity.GLOBALS.getSettings(this.context).getTimeFormat();

        this.setInputType(InputType.TYPE_CLASS_DATETIME);
        this.setClickable(true);
        this.setKeyListener(DigitsKeyListener.getInstance("0123456789 .:-/"));
    }

    private void initDialog() {
        this.calendar = Calendar.getInstance();

        this.onTimeSetListener = (timePicker, i, i1) -> {
            this.calendar.set(Calendar.HOUR_OF_DAY, i);
            this.calendar.set(Calendar.MINUTE, i1);
            this.setText(ConvertHelper.convertDateToString(this.calendar.getTime(), this.dateFormat + " " + this.timeFormat));
        };

        this.onDateSetListener = (datePicker, i, i1, i2) -> {
            this.calendar.set(Calendar.YEAR, i);
            this.calendar.set(Calendar.MONTH, i1);
            this.calendar.set(Calendar.DAY_OF_MONTH, i2);
            this.setText(ConvertHelper.convertDateToString(this.calendar.getTime(), this.dateFormat));
            if(this.timePicker) {
                Calendar calendar = this.getDefault(this.dateFormat + " " + this.timeFormat);
                new TimePickerDialog(this.context, this.onTimeSetListener, calendar.get(Calendar.HOUR_OF_DAY), calendar.get(Calendar.MINUTE), true).show();
            }
        };
    }

    private void initActions() {
        this.setOnClickListener(v -> {
            Calendar calendar = this.getDefault(this.dateFormat);
            new DatePickerDialog(
                this.context,
                this.onDateSetListener,
                calendar.get(Calendar.YEAR),
                calendar.get(Calendar.MONTH),
                calendar.get(Calendar.DAY_OF_MONTH)
            ).show();
        });
    }

    private Calendar getDefault(String format) {
        Calendar calendar;
        try {
            Date dt = ConvertHelper.convertStringToDate(Objects.requireNonNull(this.getText()).toString().trim(), format);
            calendar = Calendar.getInstance();
            calendar.setTime(dt);
        } catch (Exception ex) {
            calendar = Calendar.getInstance();
        }
        return calendar;
    }
}
